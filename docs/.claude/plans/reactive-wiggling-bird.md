# Plan: Versioned docs nav with semver-aware versions.json

## Context

Current approach archives HTML per tag using `peaceiris/actions-gh-pages` — over-engineered.

New approach:
- **latest release** → VitePress HTML site (default nav label)
- **master (dev)** → same site (secondary label in dropdown)
- **구버전** → GitHub Releases links (no HTML, latest 4개만 유지)
- **pre-release** (현재) → dropdown 자체를 숨김 (아직 릴리즈 없으므로)

Version dropdown shows at most **5 items** total: latest + up to 4 archived, sorted semver descending.

**Patch bump** (v0.1.0 → v0.1.1): replace `latest` in-place, do NOT archive old latest.
**Minor/major bump** (v0.1.x → v0.2.0 or v1.0.0): archive current latest, set new latest.
Archive capped at 4 entries (drop oldest when overflow).

`config.ts` reads `versions.json` at build time (VitePress is Node.js — `fs.readFileSync` works).
A separate `docs-release` workflow fires on `v*` tag, updates `versions.json`, commits to master.
That commit to master then triggers `docs-deploy` which rebuilds with updated nav.

---

## New Files

### `docs/scripts/update-versions.mjs`

No external dependencies. Called by CI: `node docs/scripts/update-versions.mjs v0.2.0`

Logic:
```javascript
// parse new tag from argv[2]
// parse existing versions.json
// isPatch: same major+minor → just replace latest (no archive)
// else: prepend old latest to archived, sort descending, slice to 4
// write updated versions.json
```

Semver parse + compare (pure JS, no deps):
```javascript
function parseSemver(v) {
  const [major, minor, patch] = v.replace(/^v/, '').split('.').map(Number)
  return { major, minor, patch }
}
function compareSemverDesc(a, b) {
  const pa = parseSemver(a), pb = parseSemver(b)
  return pb.major - pa.major || pb.minor - pa.minor || pb.patch - pa.patch
}
```

### `workflows/docs-release.ts`

New gaji workflow. Triggers on `push: tags: ["v*"]`.

Steps:
1. `checkout` with `ref: master` (checkout master, not the tag commit)
2. `setup-node` with `node-version: 22`
3. Run: `node docs/scripts/update-versions.mjs ${{ github.ref_name }}`
4. Run: git config + `git add docs/versions.json` + commit + push to master

The resulting master commit triggers `docs-deploy` automatically (touches `docs/`).

Permissions: `contents: write`

---

## Modified Files

### `docs/.vitepress/config.ts`

Remove `VITEPRESS_BASE` env var. Add version nav generation:

```typescript
import { readFileSync } from 'node:fs'
import { fileURLToPath } from 'node:url'
import { dirname, resolve } from 'node:path'

const __dirname = dirname(fileURLToPath(import.meta.url))
const versions = JSON.parse(
  readFileSync(resolve(__dirname, '../versions.json'), 'utf-8')
)

const BASE = 'https://nanazt.github.io/husako/'
const RELEASES = 'https://github.com/nanazt/husako/releases/tag/'

const versionNav = versions.latest ? {
  text: versions.latest,
  items: [
    { text: `${versions.latest} (latest)`, link: BASE },
    { text: 'master (dev)', link: BASE },
    ...[...versions.archived]
      .sort(compareSemverDesc)
      .map(v => ({ text: v, link: RELEASES + v }))
  ]
} : undefined  // no dropdown before first release

// nav:
nav: [
  { text: 'Guide', ... },
  { text: 'Reference', ... },
  { text: 'Advanced', ... },
  ...(versionNav ? [versionNav] : []),
],
```

### `docs/versions.json`

Keep, but reset to initial state:
```json
{
  "latest": null,
  "archived": []
}
```

### `workflows/docs-deploy.ts`

Revert to original simple `actions/deploy-pages` workflow:
- Remove `peaceiris/actions-gh-pages`
- Remove versioned build steps
- Remove `tags: ["v*"]` from `on.push`
- Restore `configure-pages` + `upload-pages-artifact` + `deploy-pages`
- Restore permissions: `contents: read, pages: write, id-token: write`

---

## Critical Files

| File | Action |
|------|--------|
| `docs/.vitepress/config.ts` | Remove env var base; add dynamic version nav |
| `docs/versions.json` | Reset to `{ "latest": null, "archived": [] }` |
| `docs/scripts/update-versions.mjs` | Create (no deps) |
| `workflows/docs-deploy.ts` | Revert to deploy-pages |
| `workflows/docs-release.ts` | Create |
| `.github/workflows/docs-deploy.yml` | Regenerated by `gaji build` |
| `.github/workflows/docs-release.yml` | Regenerated by `gaji build` |

---

## Release workflow (after implementation)

When `v0.1.0` tag is pushed:
1. `docs-release` workflow fires
2. Runs `update-versions.mjs v0.1.0` → versions.json: `{ "latest": "v0.1.0", "archived": [] }`
3. Commits to master
4. Push triggers `docs-deploy`
5. VitePress builds with versions.json → nav shows "v0.1.0" dropdown
6. Deploy to GitHub Pages

When `v0.1.1` patch is pushed:
- `latest` becomes "v0.1.1", archived stays `[]` (patch, no archive)

When `v0.2.0` minor is pushed:
- `latest` = "v0.2.0", `archived` = ["v0.1.1"] (archived the last minor)

---

## Setup Requirements (automated via `gh` CLI)

Both steps executed programmatically as part of implementation.

### 1. GitHub Pages source → GitHub Actions

```bash
gh api --method PUT repos/nanazt/husako/pages \
  -f build_type=workflow
```

### 2. Branch protection: allow `github-actions[bot]` to bypass PR requirement

Fetch current protection, then re-PUT with `bypass_pull_request_allowances.apps` = `["github-actions"]`:

```bash
# Get current protection settings
gh api repos/nanazt/husako/branches/master/protection

# Update: add github-actions[bot] to bypass_pull_request_allowances
gh api --method PUT repos/nanazt/husako/branches/master/protection \
  --input - <<'EOF'
{
  "required_status_checks": null,
  "enforce_admins": false,
  "required_pull_request_reviews": {
    "required_approving_review_count": 1,
    "bypass_pull_request_allowances": {
      "apps": ["github-actions"]
    }
  },
  "restrictions": null
}
EOF
```

Note: preserve existing protection settings (status checks, review count) when updating.

---

## Verification

```bash
# 1. Verify VitePress builds (no version dropdown — latest is null)
cd docs && npm run build   # should pass

# 2. Simulate v0.1.0 release
node docs/scripts/update-versions.mjs v0.1.0
# versions.json → { "latest": "v0.1.0", "archived": [] }

# 3. Rebuild — should now show dropdown
npm run build   # should pass

# 4. Simulate patch v0.1.1
node docs/scripts/update-versions.mjs v0.1.1
# versions.json → { "latest": "v0.1.1", "archived": [] }  ← no archive

# 5. Simulate minor v0.2.0
node docs/scripts/update-versions.mjs v0.2.0
# versions.json → { "latest": "v0.2.0", "archived": ["v0.1.1"] }

# 6. Regenerate workflows
gaji build
# should emit docs-deploy.yml + docs-release.yml

# 7. Confirm docs-deploy.yml reverted
grep "deploy-pages\|configure-pages" .github/workflows/docs-deploy.yml
grep -L "VITEPRESS_BASE\|peaceiris" .github/workflows/docs-deploy.yml

# 8. Final build to confirm all passes
npm run build
```
