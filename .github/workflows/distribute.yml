# Auto-generated by gaji
# Do not edit manually - Edit workflows/distribute.ts instead
# Generated at: 2026-02-23T17:41:24Z

jobs:
  build:
    runs-on: ${{ matrix.target.runner }}
    steps:
    - uses: actions/checkout@v5
    - uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target.rust_target }}
    - if: matrix.target.rust_target == 'aarch64-unknown-linux-gnu'
      name: Install cross-compilation tools
      run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu
    - env:
        CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
        CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
      name: Build
      run: cargo build --release --target ${{ matrix.target.rust_target }}
    - if: matrix.target.archive == 'tar.gz'
      name: Archive (unix)
      run: |-
        cd target/${{ matrix.target.rust_target }}/release
        tar czf ../../../husako-${{ matrix.target.platform }}.tar.gz ${{ matrix.target.binary }}
    - if: matrix.target.archive == 'zip'
      name: Archive (windows)
      run: Compress-Archive -Path "target/${{ matrix.target.rust_target }}/release/${{ matrix.target.binary }}" -DestinationPath "husako-${{ matrix.target.platform }}.zip"
      shell: pwsh
    - uses: actions/upload-artifact@v4
      with:
        name: binary-${{ matrix.target.platform }}
        path: husako-${{ matrix.target.platform }}.*
    - uses: actions/upload-artifact@v4
      with:
        name: npm-${{ matrix.target.platform }}
        path: target/${{ matrix.target.rust_target }}/release/${{ matrix.target.binary }}
    strategy:
      fail-fast: false
      matrix:
        target:
        - archive: tar.gz
          binary: husako
          platform: linux-x64
          runner: ubuntu-latest
          rust_target: x86_64-unknown-linux-gnu
        - archive: tar.gz
          binary: husako
          platform: linux-arm64
          runner: ubuntu-latest
          rust_target: aarch64-unknown-linux-gnu
        - archive: tar.gz
          binary: husako
          platform: darwin-x64
          runner: macos-latest
          rust_target: x86_64-apple-darwin
        - archive: tar.gz
          binary: husako
          platform: darwin-arm64
          runner: macos-latest
          rust_target: aarch64-apple-darwin
        - archive: zip
          binary: husako.exe
          platform: win32-x64
          runner: windows-latest
          rust_target: x86_64-pc-windows-msvc
  github-release:
    needs:
    - build
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
    - uses: actions/download-artifact@v4
      with:
        merge-multiple: true
        path: artifacts
        pattern: binary-*
    - name: Generate checksums
      run: |-
        cd artifacts
        sha256sum husako-* > checksums-sha256.txt
    - uses: softprops/action-gh-release@v2
      with:
        files: |-
          artifacts/husako-*
          artifacts/checksums-sha256.txt
  publish-npm:
    needs:
    - build
    permissions:
      id-token: write
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
    - uses: actions/setup-node@v4
      with:
        node-version: '22'
        registry-url: https://registry.npmjs.org
    - uses: actions/download-artifact@v4
      with:
        merge-multiple: false
        path: npm-artifacts
        pattern: npm-*
    - name: Prepare platform packages
      run: |-
        for platform in linux-x64 linux-arm64 darwin-x64 darwin-arm64 win32-x64; do
          mkdir -p "npm/platform-${platform}/bin"
          if [ -f "npm-artifacts/npm-${platform}/husako" ]; then
            cp "npm-artifacts/npm-${platform}/husako" "npm/platform-${platform}/bin/"
            chmod +x "npm/platform-${platform}/bin/husako"
          elif [ -f "npm-artifacts/npm-${platform}/husako.exe" ]; then
            cp "npm-artifacts/npm-${platform}/husako.exe" "npm/platform-${platform}/bin/"
          fi
        done
    - name: Sync versions
      run: bash scripts/sync-versions.sh
    - name: Copy README
      run: cp README.md npm/husako/
    - env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      name: Publish platform packages
      run: |-
        for dir in npm/platform-*; do
          if [ -d "$dir/bin" ] && [ "$(ls -A "$dir/bin")" ]; then
            cd "$dir"
            npm publish --provenance --access public
            cd ../..
          fi
        done
    - env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      name: Publish main package
      run: cd npm/husako && npm publish --provenance --access public
name: Distribute
on:
  push:
    tags:
    - v*
permissions:
  contents: read
